<?phpclass BannerController extends Controller{    public $layout='//layouts/column2';             	/**	 * @return array action filters	 */	public function filters()	{		return array(			'accessControl', // perform access control for CRUD operations			'postOnly + delete', // we only allow deletion via POST request		);	}        public function accessRules()	{		return array(			array('allow',  // allow all users to perform 'index' and 'view' actions				'actions'=>array('reject','updatehit'),				'users'=>array('*'),			),			array('allow', // allow authenticated user to perform 'create' and 'update' actions				'actions'=>array('index','active','makepayment','uploadbaneer','payment','update','marketing_payment','paypalreturn','paypalcancel'),				'users'=>array('@'),			),			array('allow', // allow admin user to perform 'admin' and 'delete' actions				'actions'=>array('admin','delete'),				'users'=>array('admin'),			),			array('deny',  // deny all users				'users'=>array('*'),			),		);	}	public function actionIndex()	{        $listid = $_REQUEST['listid'];        $page = (isset($_GET['page']) ? $_GET['page'] : 1); // to get the current page        $offset = ( $page - 1) *  Yii::app()->params['pageSize'];        // generate sql query for geting purchased details        $sql = "SELECT * FROM user_default_prize_points          WHERE user_default_listing_points_user_id = ".Yii::app()->user->id. " ";        $sql .= " ORDER BY 	user_default_prize_points_id DESC "; // to set ordr by        $dataProvider1 = PrizePoints::model()->findAllBySql($sql); // this query get the total number of items        // set the limit for the pagination        $sql .= " LIMIT ".$offset.",".Yii::app()->params['pageSize']; //this query contains all the data        $dataProvider  = PrizePoints::model()->findAllBySql($sql);        $itemCount     = count($dataProvider1); // total records        $pages = new CPagination($itemCount);        $pages->setPageSize(Yii::app()->params['pageSize']);        $this->render('index',array(            'listid'=>$listid,            'dataProvider'=>$dataProvider,            'itemCount'=>$itemCount,            'pageSize'=>Yii::app()->params['pageSize'],            'pages'=>$pages        ));    }        public function actionMakepayment(){         $model = new Banner;          $drg_category = Yii::app()->request->getParam('drg_category');         $banner_link = Yii::app()->request->getParam('banner_link');         $banner_path = Yii::app()->request->getParam('banner_path');         $totalWeeks = Yii::app()->request->getParam('totalWeeks');         $cost = Yii::app()->request->getParam('cost');         $listid = Yii::app()->request->getParam('listid');           $model->banner_list_id = $listid;         $model->banner_path = $banner_path;         $model->banner_duration = $totalWeeks;         $model->banner_cost = $cost;         $model->banner_approve_status = 1;         $model->drg_user_id = Yii::app()->user->getId();         $model->banner_subdate = date('Y-m-d');         $model->banner_clicks = 0;         $model->banner_link = $banner_link;                  $imagename = explode('/',$banner_path);         $newimagename = array_reverse($imagename);                  if($model->validate()){                                      $userModel = User::model()->findByPk(Yii::app()->user->getId());                         $result = move_uploaded_file($_FILES['bannerImage']['tmp_name'],getcwd().'/upload/banner-images/'.$newimagename[0]);                                       if($model->save()){                                 /* Mail code */                                                    $template =  MailTemplate::model()->findByAttributes(array("template_module"=>'banner_submission_notice'));                                                            $bannerImage = "<img src='".Yii::app()->baseUrl.'/upload/'.$model->banner_path."' title='".$model->banner_link."'/>";                                                             $string = array(                            '{{#BANNER_IMAGE#}}'=>$bannerImage,                            '{{#IMAGE_NAME#}}'=>$model->banner_link,                            '{{#BANNER_SUBMITTED_DATE#}}'=>$model->banner_subdate,                            '{{#BANNER_LINK#}}'=>$model->banner_link,                            '{{#BANNER_DURATION#}}'=>$model->banner_duration,                            '{{#AMOUNT_PAID#}}'=>$model->banner_cost,                            '{{#STATUS#}}'=>'waiting admin approval',                             '{{#USER_NAME#}}'=>$userModel->drg_name . ' ' . $userModel->drg_surname,                             '{{#COMPANY_EMAIL#}}'  => Yii::app()->params['company_email']                                );                                          $body = SharedFunctions::app()->mailStringReplace($template->template_body,$string);                                                $result =  SharedFunctions::app()->sendmail($userModel->drg_email,$template->template_subject,$body);                                          // Admin mail sent code                                          $template =  MailTemplate::model()->findByAttributes(array("template_module"=>'banner_submission_notice_admin'));                                                            $activelink = '<a href="'.Yii::app()->createAbsoluteUrl('/admin/banner/banner/view',array('bannerid'=>$model->banner_id)).'" target="_blank" >here </a>';                                                               $string = array(                        '{{#HERE#}}'=>$activelink,                        '{{#COMPANY_EMAIL#}}'  => Yii::app()->params['company_email']                            );                                          $body = SharedFunctions::app()->mailStringReplace($template->template_body,$string);                                                $result =  SharedFunctions::app()->sendmail('admin@business-supermarket.com',$template->template_subject,$body);                                                                                 $this->render('makepayment',array("model"=>$model));                                  }else {                                 $this->redirect(Yii::app()->createUrl('listing'));                 }                                    }else {           $this->redirect(Yii::app()->createUrl('listing'));             }                        }             public function actionPayment(){                $listid = Yii::app()->request->getParam('listid');                  $this->render('index',array('payment'=>'confirm'));	    }        public function actionReject(){                $listid = Yii::app()->request->getParam('code');                if(Yii::app()->user->isGuest)		{			$this->render('login');		}		else		{		    $modelReject = Banner::model()->findAllByPk($listid);               $this->render('rejcted',array("model"=>$modelReject));			}             }            public function actionUpdate(){               $id = Yii::app()->request->getParam('banner_id');                $listid = Yii::app()->request->getParam('banner_list_id');         $banner_path = Yii::app()->request->getParam('banner_link');         $imagename = explode('/',$banner_path);        $newimagename = array_reverse($imagename);        $modelReject = Banner::model()->findByPk($id);         $modelReject->banner_path = $banner_path;         $modelReject->banner_approve_status = 1;        $modelReject->drg_user_id = Yii::app()->user->getId();        $modelReject->banner_subdate = date('Y-m-d');        if($modelReject->validate()){             $result = move_uploaded_file($_FILES['bannerImage']['tmp_name'],getcwd().'/upload/banner-images/'.$newimagename[0]);             if($modelReject->save()){                 $this->redirect(Yii::app()->createUrl('listing'));                }        }else {           $this->redirect(Yii::app()->request->urlReferrer);          }                     }            public function actionUpdatehit(){                   $id = Yii::app()->request->getParam('banner_id');              $model = Banner::model()->findByPk($id);          if($model){            $model->banner_clicks = ($model->banner_clicks+1);            $model->save();          }               }            public function actionUploadbaneer(){                   }            public function actionActive(){        }    public function actionmarketing_payment($listid)    {        $d=new ExpressCheckout();        $user = new User;        $userData =User::model()->findByPk(Yii::app()->user->getId());        $userAddressData = Useraddress::model()->findByAttributes('user_default_profile_id',Yii::app()->user->getId());        $currencymodel = new Currency();        $currenyCode=Currency::model()->getCurrencyCode($userData['user_default_currency']);        $user_address = array($userAddressData['user_default_address1'],$userAddressData['user_default_address2'],$userAddressData['user_default_address3']);        $products=array(            '0'=>array(                'NAME'=>'Listing Market',                'AMOUNT'=>Yii::app()->request->getParam('cost'),                'QTY'=>'1'            ),        );        /*Optional */        $shipping_address=array(            'FIRST_NAME'=>$userData['user_default_first_name'],            'LAST_NAME'=>$userData['user_default_surname'],            'EMAIL'=>$userData['user_default_email'],            'MOB'=>$userData['user_default_tel'],            'ADDRESS'=>$user_address,            /*'SHIPTOSTREET'=>'mannarkkad',*/            /* 'SHIPTOCITY'=>'palakkad',*/            'SHIPTOSTATE'=>$userAddressData['user_default_town'],            'SHIPTOCOUNTRYCODE'=>$userAddressData['user_default_county'],            'SHIPTOZIP'=>$userAddressData['user_default_zip']        );        $d->setShippingInfo($shipping_address); // set Shipping info Optional        $x = new ECurrencyConverter();        $x->currencyConverter();        $d->setCurrencyCode($currenyCode);//set Currency (USD,HKD,GBP,EUR,JPY,CAD,AUD)        $d->setProducts($products); /* Set array of products*/        // $e->setShippingCost(5.5);/* Set Shipping cost(Optional) */        $d->returnURL=Yii::app()->createAbsoluteUrl("banner/paypalreturn/",array('listid'=>$listid,'purchasePoints'=>Yii::app()->request->getParam('purchasePoints')));        $d->cancelURL=Yii::app()->createAbsoluteUrl("banner/paypalcancel/",array('listid'=>$listid));        $result=$d->requestPayment();        /*  The response format from paypal for a payment request        Array        (            [TOKEN] => EC-9G810112EL503081W            [TIMESTAMP] => 2013-12-12T10:29:35Z            [CORRELATIONID] => 67da94aea08c3            [ACK] => Success            [VERSION] => 65.1            [BUILD] => 8725992        )            */        if(strtoupper($result["ACK"])=="SUCCESS")        {            $modelprizepoints = new PrizePoints();            $modelprizepoints->user_default_listing_points_purchased= Yii::app()->request->getParam('purchasePoints');            $modelprizepoints->user_default_listing_points_cost =  Yii::app()->request->getParam('cost');            $modelprizepoints->user_default_listing_id = $listid;            $modelprizepoints->user_default_listing_points_user_id = Yii::app()->user->getId();            $modelprizepoints->user_default_listing_points_date = date('Y-m-d');            $modelprizepoints->user_default_listing_points_time = date('H:i:s');            $modelprizepoints->user_default_listing_points_required ='135';            $modelprizepoints->save();            /*redirect to the paypal gateway with the given token */            header("location:".$d->PAYPAL_URL.$result["TOKEN"]);        }    }    public function actionPaypalReturn()    {        $listid= $_REQUEST['listid'];        $e = new ExpressCheckout;        $paymentDetails = $e->getPaymentDetails($_REQUEST['token']);        $x = new ECurrencyConverter();        $x->currencyConverter();        $user = new User;        $userData = User::model()->findByPk(Yii::app()->user->getId());        $currencymodel = new Currency();        $currenyCode = Currency::model()->getCurrencyCode($userData['user_default_currency']);        if ($paymentDetails['ACK'] == "Success") {            $ack = $e->doPayment($paymentDetails);  //2.Do payment        }        $this->redirect("banner/index/listid/$listid",array('displayDialog'=>1));    }    public function actionPaypalCancel()    {        $listid = $_REQUEST['listid'];        /*The user flow  wil come here when a user cancels the payment */        /*Do what you want*/        $this->redirect("banner/index/listid/$listid");    }}